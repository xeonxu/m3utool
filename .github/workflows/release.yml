name: Build and Release

on:
  push:
    tags:
      - "v*"  # Trigger workflow only on version tags (e.g., v0.1.0)
  workflow_dispatch: # Allow manual triggering from GitHub UI

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Prevent cancelling other jobs if one fails
      matrix:
        include:
          # --- Linux x64 (Standard) ---
          - os: ubuntu-latest
            arch: x86_64
            binary_name: m3utool
            asset_name: m3utool-linux-amd64

          # --- Linux ARM64 (Native) ---
          # Uses GitHub-hosted ARM runners (e.g., ubuntu-24.04-arm).
          # Note: This requires a Public repository or a Team/Enterprise plan.
          # If this runner is unavailable, you might need to use QEMU (slower).
          - os: ubuntu-24.04-arm
            arch: arm64
            binary_name: m3utool
            asset_name: m3utool-linux-arm64

          # --- Windows x64 ---
          - os: windows-latest
            arch: x86_64
            binary_name: m3utool.exe
            asset_name: m3utool-windows-amd64.exe

          # --- macOS ARM64 (Apple Silicon) ---
          # 'macos-latest' runs on Apple Silicon (ARM64) by default now.
          - os: macos-latest
            arch: arm64
            binary_name: m3utool
            asset_name: m3utool-macos-arm64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Common Lisp Environment
      # '40ants/setup-lisp' handles Roswell installation and Qlot caching automatically.
      # It detects the 'qlfile' in your repository and sets up the environment.
      - name: Setup Common Lisp Environment
        uses: 40ants/setup-lisp@v4
        env:
          LISP: sbcl-bin
        with:
          asdf-system: m3utool
          cache: true             # Enable caching to speed up builds

      # 2. Install Dependencies
      # Although setup-lisp prepares Qlot, running install explicitly ensures
      # all dependencies (including those from Git) are ready before the build.
      - name: Install Dependencies
        shell: bash
        run: |
          qlot install

      # 3. Build Binary
      # We use 'qlot exec' to ensure the build runs inside the isolated environment
      # defined in qlfile (e.g., using the specific cl-excel version).
      # IMPORTANT: Ensure your Makefile or ROS script handles the 'deploy'
      # library exclusion (compression-lib) to avoid path errors.
      # On Windows, we use SBCL directly to avoid Roswell/bash dependencies.
      - name: Build Binary
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows: Use SBCL directly (avoids Roswell/bash dependency issues)
            qlot exec sbcl --non-interactive \
              --eval '(ql:quickload :deploy)' \
              --eval '(deploy:define-library deploy::compression-lib :dont-deploy t)' \
              --load m3utool.asd \
              --eval '(ql:quickload :m3utool)' \
              --eval '(asdf:make :m3utool)' \
              --eval '(quit)'
          else
            # Linux/macOS: Use Roswell as before
            qlot exec ros dump executable m3utool.ros -o ${{ matrix.binary_name }}
          fi

      # 4. Prepare Artifacts
      # Rename the generated binary to include the OS/Arch suffix for clarity.
      # On Windows with ASDF/deploy, the binary is created in bin/ directory.
      - name: Rename Artifact
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows: ASDF/deploy creates binary in bin/ directory
            mv bin/${{ matrix.binary_name }} ${{ matrix.asset_name }}
          else
            # Linux/macOS: Roswell creates binary in current directory
            mv ${{ matrix.binary_name }} ${{ matrix.asset_name }}
          fi

      # 5. Upload Build Artifacts
      # Uploads the binary to the workflow run summary (useful for debugging).
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}

      # 6. Create GitHub Release
      # Only runs when a tag is pushed. Automatically attaches the built binaries to the release.
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}
