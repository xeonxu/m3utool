name: Build and Release

on:
  push:
    tags:
      - "v*"  # Trigger workflow only on version tags (e.g., v0.1.0)
  workflow_dispatch: # Allow manual triggering from GitHub UI

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Prevent cancelling other jobs if one fails
      matrix:
        include:
          # --- Linux x64 (Standard) ---
          - os: ubuntu-latest
            arch: x86_64
            binary_name: m3utool
            asset_name: m3utool-linux-amd64

          # --- Linux ARM64 (Native) ---
          # Uses GitHub-hosted ARM runners (e.g., ubuntu-24.04-arm).
          # Note: This requires a Public repository or a Team/Enterprise plan.
          # If this runner is unavailable, you might need to use QEMU (slower).
          - os: ubuntu-24.04-arm
            arch: arm64
            binary_name: m3utool
            asset_name: m3utool-linux-arm64

          # --- Windows x64 ---
          - os: windows-latest
            arch: x86_64
            binary_name: m3utool
            asset_name: m3utool-windows-amd64.exe

          # --- macOS ARM64 (Apple Silicon) ---
          # 'macos-latest' runs on Apple Silicon (ARM64) by default now.
          - os: macos-latest
            arch: arm64
            binary_name: m3utool
            asset_name: m3utool-macos-arm64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Common Lisp Environment
      # '40ants/setup-lisp' handles Roswell installation and Qlot caching automatically.
      # It detects the 'qlfile' in your repository and sets up the environment.
      # --- Windows: install a real MSYS2 environment and use its shell ---
      - name: Setup MSYS2 (Windows only)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            tar
            zstd

      - name: Setup Common Lisp Environment
        uses: 40ants/setup-lisp@v4
        env:
          LISP: sbcl-bin
        with:
          asdf-system: m3utool
          cache: true             # Enable caching to speed up builds

      # 2. Install Dependencies
      # Although setup-lisp prepares Qlot, running install explicitly ensures
      # all dependencies (including those from Git) are ready before the build.
      # --- Install dependencies ---
      - name: Install Dependencies (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          make install

      - name: Install Dependencies (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          qlot install

      # 3. Build Binary
      # We use 'qlot exec' to ensure the build runs inside the isolated environment
      # defined in qlfile (e.g., using the specific cl-excel version).
      # IMPORTANT: Ensure your Makefile or ROS script handles the 'deploy'
      # library exclusion (compression-lib) to avoid path errors.
      - name: Build Binary (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          make ros-build

      - name: Build Binary (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Use dynamic output filename based on the matrix configuration
          qlot exec ros dump executable m3utool.ros -o "${{ matrix.binary_name }}"

      # 4. Prepare Artifacts
      # Rename the generated binary to include the OS/Arch suffix for clarity.
      - name: Rename Artifact (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          mv "${{ matrix.binary_name }}" "${{ matrix.asset_name }}"

      - name: Rename Artifact (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mv "${{ matrix.binary_name }}" "${{ matrix.asset_name }}"

      # 5. Upload Build Artifacts
      # Uploads the binary to the workflow run summary (useful for debugging).
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}
          if-no-files-found: error

  release:
    name: Create GitHub Release (attach all assets)
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List downloaded files
        shell: bash
        run: |
          ls -lah dist || true
          find dist -type f -maxdepth 2 -print

      # 6. Create GitHub Release
      # Only runs when a tag is pushed. Automatically attaches the built binaries to the release.
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}
